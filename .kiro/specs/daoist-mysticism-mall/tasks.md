# 实施计划: 道家玄学商城系统

## 概述

本实施计划将道家玄学商城系统分解为可执行的编码任务。系统采用前后端分离架构，后端使用ThinkPHP 6.x (PHP)，前端使用Vue.js 3.x + Element UI (JavaScript)。任务按照从基础设施到核心功能再到集成的顺序组织，确保每个步骤都可以增量验证。

## 任务

- [x] 1. 搭建项目基础架构
  - 创建后端ThinkPHP项目结构
  - 创建前端Vue.js项目结构
  - 配置数据库连接和Redis
  - 设置开发环境配置文件
  - _需求: 13.1, 14.1_

- [ ] 2. 实现数据库表结构
  - [x] 2.1 创建所有数据库表的迁移文件
    - 创建users、categories、products、orders、order_items表
    - 创建videos、articles、feng_shui_masters表
    - 创建payment_configs、chat_sessions、chat_messages表
    - 添加索引和外键约束
    - _需求: 12.1_

  - [x] 2.2 编写数据库表结构测试
    - 验证所有表和字段存在
    - 验证索引和外键约束正确
    - _需求: 12.1_

- [ ] 3. 实现用户认证和授权系统
  - [x] 3.1 创建JWT认证中间件
    - 实现token生成和验证逻辑
    - 实现AuthMiddleware类
    - _需求: 11.1, 11.2, 11.4_

  - [x] 3.2 实现用户登录功能
    - 创建登录API端点
    - 实现密码验证和token生成
    - _需求: 11.1, 11.2_

  - [x] 3.3 编写认证属性测试
    - **属性 41: 正确凭证生成令牌**
    - **验证需求: 11.2**

  - [x] 3.4 编写认证属性测试
    - **属性 42: 错误凭证拒绝登录**
    - **验证需求: 11.3**

  - [x] 3.5 编写授权属性测试
    - **属性 43: 有效令牌访问授权**
    - **属性 44: 无效令牌拒绝访问**
    - **验证需求: 11.4, 11.5**

  - [x] 3.6 实现角色权限验证
    - 实现Admin和User角色检查
    - 创建权限验证中间件
    - _需求: 11.6, 11.7_

  - [x] 3.7 编写角色权限属性测试
    - **属性 45: Admin角色权限验证**
    - **属性 46: 普通用户权限限制**
    - **验证需求: 11.6, 11.7**

- [x] 4. 检查点 - 确保认证系统正常工作
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. 实现用户管理模块
  - [x] 5.1 创建User模型和验证器
    - 实现User模型类
    - 实现用户数据验证规则
    - _需求: 2.2_

  - [x] 5.2 实现UserService业务逻辑
    - 实现createUser、updateUser、deleteUser方法
    - 实现getUserList和搜索功能
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.6_

  - [x] 5.3 编写用户管理属性测试
    - **属性 4: 用户名唯一性约束**
    - **属性 5: 邮箱格式验证**
    - **验证需求: 2.2**

  - [x] 5.4 编写用户管理属性测试
    - **属性 7: 软删除不变量**
    - **属性 8: 禁用用户无法登录**
    - **验证需求: 2.4, 2.5**

  - [x] 5.5 创建用户管理API端点
    - 实现GET /api/users（列表）
    - 实现POST /api/users（创建）
    - 实现PUT /api/users/:id（更新）
    - 实现DELETE /api/users/:id（删除）
    - 实现PATCH /api/users/:id/status（状态管理）
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 5.6 编写用户API集成测试
    - 测试所有用户管理端点
    - 测试权限控制
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 6. 实现商品分类管理模块
  - [x] 6.1 创建Category模型和服务
    - 实现Category模型类
    - 实现CategoryService业务逻辑
    - _需求: 4.1, 4.3_

  - [x] 6.2 编写分类管理属性测试
    - **属性 15: 分类名称非空约束**
    - **属性 16: 分类删除约束**
    - **属性 17: 分类排序正确性**
    - **验证需求: 4.2, 4.4, 4.5**

  - [x] 6.3 创建分类管理API端点
    - 实现GET /api/categories（列表）
    - 实现POST /api/categories（创建）
    - 实现PUT /api/categories/:id（更新）
    - 实现DELETE /api/categories/:id（删除）
    - 实现PATCH /api/categories/:id/status（状态管理）
    - _需求: 4.1, 4.3, 4.4, 4.6_

- [ ] 7. 实现商品管理模块
  - [x] 7.1 创建Product模型和服务
    - 实现Product模型类
    - 实现ProductService业务逻辑
    - _需求: 3.1, 3.4_

  - [x] 7.2 编写商品管理属性测试
    - **属性 10: 商品价格正值约束**
    - **属性 11: 商品库存非负约束**
    - **属性 12: 商品软删除不变量**
    - **验证需求: 3.2, 3.3, 3.5**

  - [x] 7.3 编写商品可见性属性测试
    - **属性 13: 上架商品可见性**
    - **属性 14: 下架商品不可见性**
    - **验证需求: 3.6, 3.7**

  - [x] 7.4 创建商品管理API端点
    - 实现GET /api/products（列表和搜索）
    - 实现POST /api/products（创建）
    - 实现PUT /api/products/:id（更新）
    - 实现DELETE /api/products/:id（删除）
    - 实现PATCH /api/products/:id/status（上下架）
    - _需求: 3.1, 3.4, 3.5, 3.6, 3.7, 3.8_

- [ ] 8. 实现订单管理模块
  - [x] 8.1 创建Order和OrderItem模型
    - 实现Order模型类
    - 实现OrderItem模型类
    - _需求: 5.1_

  - [x] 8.2 实现OrderService业务逻辑
    - 实现createOrder方法（包含库存扣减和事务）
    - 实现shipOrder方法
    - 实现cancelOrder方法（包含库存恢复）
    - _需求: 5.3, 5.4, 5.5, 5.6_

  - [x] 8.3 编写订单创建属性测试
    - **属性 19: 订单创建库存扣减**
    - **属性 20: 库存不足拒绝订单**
    - **验证需求: 5.5**

  - [x] 8.4 编写订单管理属性测试
    - **属性 21: 发货状态转换**
    - **属性 22: 发货物流信息必填**
    - **属性 23: 取消订单库存恢复**
    - **验证需求: 5.3, 5.4, 5.5**

  - [x] 8.5 创建订单管理API端点
    - 实现GET /api/orders（列表和搜索）
    - 实现GET /api/orders/:id（详情）
    - 实现POST /api/orders（创建）
    - 实现POST /api/orders/:id/ship（发货）
    - 实现POST /api/orders/:id/cancel（取消）
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.7, 5.8_

- [ ] 9. 检查点 - 确保核心业务功能正常
  - 确保所有测试通过，如有问题请询问用户

- [ ] 10. 实现支付集成模块
  - [x] 10.1 创建PaymentConfig模型和服务
    - 实现PaymentConfig模型类
    - 实现支付配置管理功能
    - _需求: 9.1, 9.2, 9.3, 9.4_

  - [x] 10.2 实现PaymentService和支付网关
    - 实现AlipayGateway类
    - 实现WechatGateway类
    - 实现PaypalGateway类
    - 实现createPayment和handleCallback方法
    - _需求: 9.1, 9.2, 9.3_

  - [x] 10.3 编写支付配置属性测试
    - **属性 33: 支付配置必填字段验证**
    - **属性 34: 启用支付方式可见性**
    - **属性 35: 禁用支付方式不可见性**
    - **验证需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6**

  - [x] 10.4 创建支付相关API端点
    - 实现GET /api/payment-configs（配置列表）
    - 实现POST /api/payment-configs（保存配置）
    - 实现POST /api/payments（创建支付）
    - 实现POST /api/payments/callback（支付回调）
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [ ] 11. 实现客服聊天模块
  - [x] 11.1 创建ChatSession和ChatMessage模型
    - 实现ChatSession模型类
    - 实现ChatMessage模型类
    - _需求: 10.1_

  - [x] 11.2 实现ChatService业务逻辑
    - 实现createSession方法
    - 实现sendMessage方法
    - 实现closeSession方法
    - 实现checkInactiveSessions定时任务
    - _需求: 10.1, 10.6, 10.7_

  - [x] 11.3 编写客服管理属性测试
    - **属性 36: 聊天会话创建**
    - **属性 39: 结束会话状态转换**
    - **属性 40: 超时会话自动转换**
    - **验证需求: 10.1, 10.6, 10.7**

  - [x] 11.4 实现WebSocket服务器
    - 配置WebSocket服务器
    - 实现消息推送逻辑
    - 实现会话管理
    - _需求: 10.2, 10.3_

  - [x] 11.5 创建客服管理API端点
    - 实现GET /api/chat/sessions（会话列表）
    - 实现GET /api/chat/sessions/:id/messages（聊天记录）
    - 实现POST /api/chat/sessions（创建会话）
    - 实现POST /api/chat/sessions/:id/close（结束会话）
    - 实现WebSocket端点 /ws/chat
    - _需求: 10.1, 10.4, 10.5, 10.6_

- [ ] 12. 实现内容管理模块
  - [x] 12.1 创建Video模型和服务
    - 实现Video模型类
    - 实现VideoService业务逻辑
    - _需求: 6.1, 6.4_

  - [x] 12.2 创建Article模型和服务
    - 实现Article模型类
    - 实现ArticleService业务逻辑
    - _需求: 7.1, 7.4_

  - [x] 12.3 创建FengShuiMaster模型和服务
    - 实现FengShuiMaster模型类
    - 实现FengShuiMasterService业务逻辑
    - _需求: 8.1, 8.3_

  - [x] 12.4 编写内容管理属性测试
    - **属性 25-32: 视频、文章、风水师管理属性**
    - **验证需求: 6.1-6.6, 7.1-7.7, 8.1-8.5**

  - [x] 12.5 创建内容管理API端点
    - 实现视频管理端点（GET/POST/PUT/DELETE /api/videos）
    - 实现文章管理端点（GET/POST/PUT/DELETE /api/articles）
    - 实现风水师管理端点（GET/POST/PUT/DELETE /api/feng-shui-masters）
    - _需求: 6.1-6.6, 7.1-7.7, 8.1-8.5_

- [ ] 13. 实现文件上传模块
  - [x] 13.1 创建FileService
    - 实现uploadImage方法
    - 实现文件类型和大小验证
    - 实现文件名生成和目录组织
    - _需求: 15.1, 15.2, 15.3, 15.5, 15.6_

  - [x] 13.2 编写文件上传属性测试
    - **属性 56: 文件类型验证**
    - **属性 57: 文件大小验证**
    - **属性 59: 文件名唯一性**
    - **属性 60: 文件目录组织**
    - **验证需求: 15.1, 15.2, 15.5, 15.6**

  - [x] 13.3 创建文件上传API端点
    - 实现POST /api/upload/image
    - _需求: 15.1, 15.2, 15.3, 15.4_

- [ ] 14. 实现仪表盘统计模块
  - [x] 14.1 创建StatisticsService
    - 实现getDashboardData方法
    - 实现各项统计查询
    - _需求: 1.1, 1.2, 1.3_

  - [x] 14.2 编写仪表盘统计属性测试
    - **属性 1: 统计数据准确性**
    - **属性 2: 订单状态统计准确性**
    - **属性 3: 最近订单列表正确性**
    - **验证需求: 1.1, 1.2, 1.3**

  - [x] 14.3 创建仪表盘API端点
    - 实现GET /api/dashboard/stats
    - _需求: 1.1, 1.2, 1.3_

- [ ] 15. 实现统一错误处理
  - [x] 15.1 创建异常处理器
    - 实现ExceptionHandler类
    - 实现各类异常的处理逻辑
    - 实现统一错误响应格式
    - _需求: 13.3, 13.5_

  - [x] 15.2 编写错误处理属性测试
    - **属性 51: 统一响应结构**
    - **属性 53: 失败响应状态码**
    - **验证需求: 13.3, 13.5**

- [ ] 16. 实现API响应规范
  - [x] 16.1 创建响应格式化中间件
    - 实现统一的JSON响应格式
    - 实现CORS配置
    - 实现Content-Type设置
    - _需求: 13.2, 13.3, 13.6, 13.7_

  - [x] 16.2 编写API规范属性测试
    - **属性 50: JSON响应格式**
    - **属性 52: 成功响应状态码**
    - **属性 54: CORS头存在性**
    - **属性 55: Content-Type头正确性**
    - **验证需求: 13.2, 13.4, 13.6, 13.7**

- [x] 17. 检查点 - 确保后端API完整
  - 确保所有测试通过，如有问题请询问用户

- [ ] 18. 实现前端基础架构
  - [x] 18.1 配置Vue Router
    - 创建路由配置文件
    - 实现路由守卫（认证检查）
    - _需求: 14.1_

  - [x] 18.2 配置Vuex状态管理
    - 创建用户状态模块
    - 创建购物车状态模块
    - _需求: 14.1_

  - [x] 18.3 配置Axios HTTP客户端
    - 创建API请求封装
    - 实现请求拦截器（添加token）
    - 实现响应拦截器（错误处理）
    - _需求: 14.3, 14.4, 14.5_

  - [x] 18.4 编写前端错误处理测试
    - 测试错误拦截器
    - 测试错误提示显示
    - _需求: 14.4_

- [ ] 19. 实现前端用户认证界面
  - [x] 19.1 创建登录页面组件
    - 实现登录表单
    - 实现客户端验证
    - 实现登录逻辑
    - _需求: 11.1, 14.7_

  - [x] 19.2 创建用户状态管理
    - 实现登录action
    - 实现登出action
    - 实现token存储
    - _需求: 11.2_

- [ ] 20. 实现前端管理后台界面
  - [x] 20.1 创建仪表盘页面
    - 实现统计数据展示组件
    - 实现订单状态统计组件
    - 实现最近订单列表组件
    - _需求: 1.1, 1.2, 1.3_

  - [x] 20.2 创建用户管理页面
    - 实现用户列表组件
    - 实现用户创建/编辑表单
    - 实现用户搜索功能
    - 实现用户状态管理
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

  - [x] 20.3 创建商品分类管理页面
    - 实现分类列表组件
    - 实现分类创建/编辑表单
    - 实现分类排序功能
    - _需求: 4.1, 4.3, 4.5, 4.6_

  - [x] 20.4 创建商品管理页面
    - 实现商品列表组件
    - 实现商品创建/编辑表单
    - 实现商品搜索功能
    - 实现商品上下架功能
    - _需求: 3.1, 3.4, 3.6, 3.7, 3.8_

  - [x] 20.5 创建订单管理页面
    - 实现订单列表组件
    - 实现订单详情组件
    - 实现订单搜索和筛选
    - 实现发货和取消功能
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.7, 5.8_

  - [x] 20.6 创建视频管理页面
    - 实现视频列表组件
    - 实现视频创建/编辑表单
    - _需求: 6.1, 6.4, 6.6_

  - [x] 20.7 创建资讯管理页面
    - 实现文章列表组件
    - 实现文章创建/编辑表单（富文本编辑器）
    - 实现文章发布/撤回功能
    - _需求: 7.1, 7.4, 7.6, 7.7_

  - [x] 20.8 创建风水师管理页面
    - 实现风水师列表组件
    - 实现风水师创建/编辑表单
    - _需求: 8.1, 8.3, 8.5_

  - [x] 20.9 创建支付配置页面
    - 实现支付配置表单（支付宝、微信、PayPal）
    - 实现支付方式启用/禁用功能
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

  - [x] 20.10 创建客服管理页面
    - 实现会话列表组件
    - 实现聊天窗口组件
    - 实现WebSocket连接
    - 实现实时消息收发
    - _需求: 10.1, 10.4, 10.5, 10.6_

- [x] 21. 实现前端用户界面
  - [x] 21.1 创建商品展示页面
    - 实现商品列表组件
    - 实现商品详情组件
    - 实现分类筛选
    - _需求: 3.6, 4.6_

  - [x] 21.2 创建购物车和结算页面
    - 实现购物车组件
    - 实现订单确认页面
    - 实现支付页面
    - _需求: 5.1, 9.5, 9.6_

  - [x] 21.3 创建内容展示页面
    - 实现视频列表和播放页面
    - 实现资讯列表和详情页面
    - 实现风水师列表和详情页面
    - _需求: 6.6, 7.6, 8.5_

  - [x] 21.4 创建客服聊天组件
    - 实现聊天窗口组件
    - 实现WebSocket连接
    - 实现消息发送和接收
    - _需求: 10.1, 10.2, 10.3_

- [x] 22. 实现文件上传组件
  - [x] 22.1 创建图片上传组件
    - 实现图片选择和预览
    - 实现上传进度显示
    - 实现客户端文件验证
    - _需求: 15.1, 15.2, 14.7_

- [ ] 23. 数据持久化和事务测试
  - [x] 23.1 编写事务属性测试
    - **属性 47: 事务回滚一致性**
    - **属性 48: 更新时间戳自动更新**
    - **属性 49: 软删除数据保留**
    - **验证需求: 12.1, 12.2, 12.4, 12.5**

- [x] 24. 最终检查点 - 端到端测试
  - 确保所有测试通过，如有问题请询问用户

- [x] 25. 集成和部署准备
  - [x] 25.1 配置生产环境
    - 创建生产环境配置文件
    - 配置环境变量
    - 配置日志记录
    - _需求: 13.1_

  - [x] 25.2 创建部署文档
    - 编写安装说明
    - 编写配置说明
    - 编写API文档
    - _需求: 13.1_

  - [x] 25.3 执行完整的端到端测试
    - 测试完整的用户购物流程
    - 测试完整的管理流程
    - 测试支付流程
    - _需求: 所有需求_

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界条件
